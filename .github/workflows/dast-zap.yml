name: Reusable DAST - OWASP ZAP (Kubernetes)

on:
  workflow_call:
    inputs:
      kubeconfig-secret:
        description: 'Name of secret containing kubeconfig (optional, for remote clusters)'
        required: false
        type: string
        default: ''
      namespace:
        description: 'Kubernetes namespace where app is deployed'
        required: false
        type: string
        default: 'travelo'
      skip-scan:
        description: 'Skip scan (for local clusters not accessible from CI)'
        required: false
        type: boolean
        default: true
    secrets:
      kubeconfig:
        description: 'Base64-encoded kubeconfig for cluster access'
        required: false

jobs:
  dast-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if scan should run
        id: check
        run: |
          if [ "${{ inputs.skip-scan }}" = "true" ]; then
            echo "DAST scan skipped - local cluster not accessible from CI"
            echo "To run DAST manually, use the Kubernetes Job: travelo-k8s/dast-zap-job.yaml"
            echo "Instructions: kubectl apply -f travelo-k8s/dast-zap-job.yaml"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup kubectl
        if: steps.check.outputs.skip == 'false'
        uses: azure/setup-kubectl@v3
        continue-on-error: true

      - name: Configure kubeconfig
        if: steps.check.outputs.skip == 'false'
        run: |
          if [ -n "${{ secrets.kubeconfig }}" ]; then
            mkdir -p ~/.kube
            echo "${{ secrets.kubeconfig }}" | base64 -d > ~/.kube/config
            chmod 600 ~/.kube/config
          fi
        continue-on-error: true

      - name: Apply DAST Job
        if: steps.check.outputs.skip == 'false'
        run: |
          # Assumes dast-zap-job.yaml exists in the infra repo
          kubectl apply -f dast-zap-job.yaml -n ${{ inputs.namespace }}

      - name: Wait for scan completion
        if: steps.check.outputs.skip == 'false'
        run: |
          kubectl wait --for=condition=complete --timeout=600s \
            job/dast-zap-scan -n ${{ inputs.namespace }}

      - name: Extract scan results
        if: steps.check.outputs.skip == 'false'
        run: |
          POD=$(kubectl get pods -n ${{ inputs.namespace }} \
            -l job-name=dast-zap-scan -o jsonpath='{.items[0].metadata.name}')

          kubectl cp ${{ inputs.namespace }}/$POD:/zap/wrk/report.html ./dast-frontend-report.html || true
          kubectl cp ${{ inputs.namespace }}/$POD:/zap/wrk/report.json ./dast-frontend-report.json || true
          kubectl cp ${{ inputs.namespace }}/$POD:/zap/wrk/report-api.html ./dast-backend-report.html || true
          kubectl cp ${{ inputs.namespace }}/$POD:/zap/wrk/report-api.json ./dast-backend-report.json || true

      - name: Upload ZAP reports
        if: always() && steps.check.outputs.skip == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: dast-zap-reports
          path: |
            dast-*-report.html
            dast-*-report.json
          retention-days: 30

      - name: Display manual instructions
        if: steps.check.outputs.skip == 'true'
        run: |
          cat << 'EOF'
          ===============================================
          DAST Scan - Manual Execution Required
          ===============================================

          This DAST scan requires running OWASP ZAP inside your Kubernetes cluster.

          To run the scan manually:

          1. Apply the Job to your cluster:
             kubectl apply -f travelo-k8s/dast-zap-job.yaml

          2. Watch the scan progress:
             kubectl logs -f job/dast-zap-scan -n travelo

          3. Extract results when complete:
             POD=$(kubectl get pods -n travelo -l job-name=dast-zap-scan -o jsonpath='{.items[0].metadata.name}')
             kubectl cp travelo/$POD:/zap/wrk/report.html ./dast-report.html

          4. Cleanup:
             kubectl delete job dast-zap-scan -n travelo

          See: travelo-infra/travelo-k8s/dast-zap-job.yaml for full instructions
          ===============================================
          EOF
